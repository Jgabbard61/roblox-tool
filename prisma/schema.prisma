// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id                Int                 @id @default(autoincrement())
  name              String
  is_active         Boolean             @default(true)
  created_at        DateTime            @default(now())
  max_users         Int                 @default(5)
  contact_email     String?             @unique
  logo_url          String?
  stripe_customer_id String?             @unique

  users             User[]
  searches          SearchHistory[]
  apiClients        ApiClient[]
  customerCredits   CustomerCredits[]

  @@map("customers")
}

model User {
  id                Int       @id @default(autoincrement())
  username          String    @unique
  password_hash     String
  role              String    @default("USER")
  email             String?
  is_active         Boolean   @default(true)
  created_at        DateTime  @default(now())
  customer_id       Int?
  email_verified    Boolean   @default(false)
  email_verified_at DateTime?

  customer          Customer? @relation(fields: [customer_id], references: [id])

  @@map("users")
}

model SearchHistory {
  id             Int       @id @default(autoincrement())
  search_query   String
  result_found   Boolean
  searched_at    DateTime  @default(now())
  customer_id    Int?
  user_id        Int?
  search_mode    String?   // exact, smart, display
  user_data      String?   @db.Text // Store full user profile data as JSON

  customer       Customer? @relation(fields: [customer_id], references: [id])

  @@index([customer_id])
  @@index([searched_at])
  @@map("search_history")
}

model CustomerStats {
  id                Int      @id @default(autoincrement())
  customer_id       Int      @unique
  total_searches    Int      @default(0)
  successful_searches Int    @default(0)
  last_search_at    DateTime?

  @@map("customer_stats")
}

model UserActivity {
  id              Int      @id @default(autoincrement())
  user_id         Int
  activity_type   String
  details         String?  @db.Text
  created_at      DateTime @default(now())

  @@index([user_id])
  @@index([created_at])
  @@map("user_activity")
}

model CreditPackages {
  id              Int      @id @default(autoincrement())
  name            String   @unique
  credits         Int
  price_cents     Int
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  price_usd       Decimal? @db.Decimal(10, 2)

  @@map("credit_packages")
}

model CustomerCredits {
  id              Int      @id @default(autoincrement())
  customer_id     Int
  credits         Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  customer        Customer @relation(fields: [customer_id], references: [id])

  @@unique([customer_id])
  @@map("customer_credits")
}

model CreditTransactions {
  id              Int      @id @default(autoincrement())
  customer_id     Int
  amount          Int
  transaction_type String
  description     String?
  created_at      DateTime @default(now())
  stripe_payment_intent_id String?

  @@index([customer_id])
  @@index([created_at])
  @@map("credit_transactions")
}

model StripePayments {
  id                    Int      @id @default(autoincrement())
  customer_id           Int
  payment_intent_id     String   @unique
  amount_cents          Int
  credits_purchased     Int
  status                String
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  @@index([customer_id])
  @@map("stripe_payments")
}

model SearchResultCache {
  id              Int      @id @default(autoincrement())
  search_key      String   @unique
  result_data     String   @db.Text
  created_at      DateTime @default(now())
  expires_at      DateTime
  hit_count       Int      @default(0)
  last_hit_at     DateTime?

  @@index([expires_at])
  @@index([created_at])
  @@map("search_result_cache")
}

// API-specific models

model ApiClient {
  id                Int         @id @default(autoincrement())
  customer_id       Int
  name              String
  description       String?
  webhook_url       String?
  is_active         Boolean     @default(true)
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt

  customer          Customer    @relation(fields: [customer_id], references: [id])
  apiKeys           ApiKey[]
  apiUsage          ApiUsage[]

  @@index([customer_id])
  @@map("api_clients")
}

model ApiKey {
  id                Int         @id @default(autoincrement())
  api_client_id     Int
  key_hash          String      @unique
  key_prefix        String      // First few chars for identification
  name              String
  scopes            String[]    // Array of permission scopes
  rate_limit        Int         @default(1000) // Requests per hour
  is_active         Boolean     @default(true)
  last_used_at      DateTime?
  expires_at        DateTime?
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt

  apiClient         ApiClient   @relation(fields: [api_client_id], references: [id])
  apiUsage          ApiUsage[]

  @@index([api_client_id])
  @@index([key_hash])
  @@map("api_keys")
}

model ApiUsage {
  id                Int         @id @default(autoincrement())
  api_client_id     Int
  api_key_id        Int
  endpoint          String
  method            String
  status_code       Int
  response_time_ms  Int
  credits_used      Int         @default(0)
  ip_address        String?
  user_agent        String?
  created_at        DateTime    @default(now())

  apiClient         ApiClient   @relation(fields: [api_client_id], references: [id])
  apiKey            ApiKey      @relation(fields: [api_key_id], references: [id])

  @@index([api_client_id])
  @@index([api_key_id])
  @@index([created_at])
  @@map("api_usage")
}

model CreditTransaction {
  id                Int         @id @default(autoincrement())
  customer_id       Int
  amount            Int
  balance_after     Int
  transaction_type  String      // 'credit', 'debit'
  source            String      // 'api', 'web', 'purchase', 'refund'
  description       String?
  metadata          Json?
  created_at        DateTime    @default(now())

  @@index([customer_id])
  @@index([created_at])
  @@map("credit_transaction")
}

model SearchCache {
  id                Int         @id @default(autoincrement())
  cache_key         String      @unique
  search_type       String      // 'username', 'user_id', 'batch'
  result_data       String      @db.Text
  ttl_seconds       Int
  hit_count         Int         @default(0)
  last_accessed_at  DateTime    @default(now())
  created_at        DateTime    @default(now())
  expires_at        DateTime

  @@index([cache_key])
  @@index([expires_at])
  @@map("search_cache")
}
